<!--

 * Copyright (c) 2005-2015 LabKey Corporation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.

 -->
<project name="test" default="usage">

    <antversion property="ant.version.check" atleast="1.8.0" />
    <fail message="Please use Ant 1.8.0 or greater. A copy is checked in to LABKEY_ROOT/external/ant" unless="ant.version.check" />

    <property environment="env"/>
    <property name="test.dir" location="${ant.file}/.."/>

    <loadproperties srcfile="${test.dir}/test.properties" prefix="default"/>

    <property name="test.build.home" value="${test.dir}/build"/>
    <property name="test.build.uptodate" value="${test.build.home}/.uptodate"/>
    <property name="test.src.home" value="${test.dir}/src"/>
    <property name="project.root" value="${test.dir}/../.." />
    <property name="test.lib.home" value="${test.dir}/lib"/>
    <property name="chrome.extensions.dir" value="${test.dir}/chromeextensions"/>
    <property name="external.lib.home" value="${project.root}/external/lib/server"/>
    <property name="test.log.dir" value="${test.dir}/logs"/>
    <property name="test.log.output.dir" value="${test.build.home}/logs" />
    <property name="javaclient.dir" value="${project.root}/remoteapi/java"/>
    <property name="javaclient.build.xml" value="${javaclient.dir}/build.xml"/>
    <property name="javaclientjar.dir" value="${project.root}/build/client-api/java/jar"/>
    <property name="javaclientlib.dir" value="${javaclient.dir}/lib"/>
    <property name="deploy.dir" value="${project.root}/build/deploy" />
    <property name="deploy.webapp.dir" value="${deploy.dir}/labkeyWebapp" />
    <property name="test.credentials.file" location="${test.dir}/test.credentials.json"/>

    <property name="modulesFile" value="standard.modules" />
    <property name="modulesFile.fullpath" value="${project.root}/server/${modulesFile}" />

    <property name="staging.modules.dir" value="${project.root}/build/staging/modules"/>
    <property name="deploy.modules.dir" value="${project.root}/build/deploy/modules"/>

    <!-- All java compilation tasks should use this property when specifying source and target version. -->
    <property name="java.source.and.target" value="1.8" />

    <property name="test.compile.debug" value="true"/>
    <property name="test.compile.deprecation" value="false"/>
    <property name="test.compile.optimize" value="true"/>

    <!-- Grab product.version set by TeamCity if it is there -->
    <condition property="product.version" value="${teamcity.product.version}" else="DevBuild" >
        <isset property="teamcity.product.version"/>
    </condition>
    <property name="version" value="${product.version}"/>

    <condition property="windows">
        <os family="windows"/>
    </condition>

    <condition property="unix">
        <os family="unix"/>
    </condition>

    <target name="usage">
        <echo message="Valid Test Targets:" />
        <echo message="drt                run developer regression tests (short suite)" />
        <echo message="bvt                run build verification tests (long suite)" />
        <echo message="daily              run daily test suite" />
        <echo message="continue           continue running a suite after a failure, starting with the test that failed" />
        <echo message="continue-debug     continue running a suite after a failure, starting with the test that failed, but suspend until debugger attaches" />
        <echo message="drt-debug          run drt, but suspend until debugger attaches" />
        <echo message="bvt-debug          run bvt, but suspend until debugger attaches" />
        <echo message="daily-debug        run daily, but suspend until debugger attaches" />
        <echo message="drt-clean          clean up after drt tests"/>
        <echo message="bvt-clean          clean up after bvt tests"/>
        <echo message="daily-clean        clean up after daily tests"/>
        <echo message="setPassword        reset your stored password" />
        <echo message="ms2t               run MS2 tests" />
        <echo message="cluster            run MS2 cluster pipeline tests" />
        <echo message="xtandem            run X! Tandem tests" />
        <echo message="study              run study tests" />
        <echo message="mascot             run Mascot tests" />
        <echo message="sequest            run Sequest tests" />
        <echo message="test               runs UI for selecting and running specific tests" />
        <echo message="usage              displays this message"/>
        <echo message=""/>
        <echo message="To specify individual tests classes to be run, add:"/>
        <echo message="    -Dtest=&quot;{name}[,{name}]&quot;"/>
        <echo message="{name} is the name of any test class, optionally dropping a trailing"/>
        <echo message="'Test' from the name."/>
        <echo message="  e.g. MS2, ms2, and MS2Test would all run the tests in MS2Test.java"/>
        <echo message="{name} may also contain any number of test methods, separated by dots; method names are case-sensitive"/>
        <echo message="  e.g. BasicTest.testSearch.testCredits"/>
        <echo message=""/>
        <echo message="To specify a named test suite (e.g., Flow, Wiki, IE) to be run or cleaned, use:"/>
        <echo message="    ant test -Dsuite={name}"/>
        <echo message=""/>
        <echo message="To continue to run all tests even if there is a failure, add:"/>
        <echo message="    -DhaltOnError=false"/>
        <echo message=""/>
        <echo message="To run tests in an infinite loop, add:"/>
        <echo message="    -Dloop=true"/>
        <echo message=""/>
        <echo message="By default, labkey is accessed at port 8080."/>
        <echo message="To specify a different port, add:" />
        <echo message="    -Dlabkey.port={portnumber}"/>
        <echo message=""/>
        <echo message="It is sometimes useful to skip post-test cleanup, leaving the test data on the site."/>
        <echo message="To skip cleanup for all tests:"/>
        <echo message="    -Dclean=false"/>
        <echo message=""/>
        <echo message="If a test fails or you've previously used -Dclean=false, you may want to force a test"/>
        <echo message="(or a group of tests) to perform post-test cleanup."/>
        <echo message="To perform just the cleanup steps of the specified test(s):"/>
        <echo message="    -DcleanOnly=true"/>
        <echo message=""/>
        <echo message="By default, labkey is accessed at context path '/labkey'."/>
        <echo message="To specify a different context path, add:"/>
        <echo message="    -Dlabkey.contextpath={contextpath}"/>
        <echo message=""/>
        <echo message="For extra coverage, the harness can crawl all new links after each test, checking for"/>
        <echo message="404 and 500 errors.  This provides extra safely, but adds time.  To enable link checking:"/>
        <echo message="    -DlinkCheck=true"/>
        <echo message=""/>
        <echo message="Add javascript injection testing:"/>
        <echo message="    -DinjectCheck=true"/>
        <echo message=""/>
        <echo message="Enable view verification:"/>
        <echo message="    -DviewCheck=true"/>
        <echo message=""/>
        <echo message="The leak checker is run by default for DRT and BVT tests.  To disable mem checking:"/>
        <echo message="    -DmemCheck=false"/>
        <echo message=""/>
        <echo message="Disable javascript error checking:"/>
        <echo message="    -DscriptCheck=false"/>
        <echo message=""/>
        <echo message="Create a new WebDriver instance for each test:"/>
        <echo message="    -Dselenium.reuseWebDriver=false"/>
        <echo message=""/>
        <echo message="Disable query validation checking:"/>
        <echo message="    -DqueryCheck=false"/>
        <echo message=""/>
        <echo message="Randomize test order."/>
        <echo message="    -DshuffleTests=true"/>
    </target>

    <target name="clean">
        <delete dir="${test.build.home}" />
    </target>

    <target name="delete_logs">
        <echo message="Deleting log files from ${tomcat.home}/logs"/>
        <delete failonerror="false" dir="${tomcat.home}/logs" />
        <echo message="Deleting tomcat temp dir ${tomcat.home}/temp"/>
        <delete failonerror="false" dir="${tomcat.home}/temp" />
        <delete file="${test.dir}/../teamcity-info.xml"/>
        <mkdir dir="${tomcat.home}/logs" />
        <mkdir dir="${tomcat.home}/temp" />
    </target>

    <target name="prepare">
        <mkdir dir="${test.build.home}/classes" />
        <mkdir dir="${test.log.output.dir}" />
    </target>

    <path id="test.lib.classpath">
        <fileset dir="${test.lib.home}">
            <include name="*.jar"/>
        </fileset>
        <fileset dir="${external.lib.home}">
            <include name="annotations.jar"/>
            <include name="commons-beanutils-1.7.jar" />
            <include name="commons-lang3-3.4.jar" />
            <include name="collections-generic-4.01.jar" />
            <include name="json_simple-1.1.jar" />
            <include name="junit-4.12.jar"/>
            <include name="tika-app-1.5.jar"/>
            <include name="log4j-1.2.16.jar"/>
            <include name="xbean.jar" />
            <include name="jackson-core-2.5.4.jar" />
            <include name="jackson-annotations-2.5.4.jar" />
            <include name="jackson-databind-2.5.4.jar" />
        </fileset>
        <fileset dir="${javaclientjar.dir}">
            <include name="labkey-client-api-${product.version}.jar"/>
        </fileset>
        <fileset dir="${javaclientlib.dir}">
            <include name="*.jar"/>
        </fileset>
        <fileset dir="${deploy.webapp.dir}/WEB-INF/lib">
            <include name="schemas.jar"/>
            <include name="api.jar"/>
        </fileset>
    </path>

    <path id="test.build.classpath">
        <path refid="test.lib.classpath" />
        <pathelement path="${test.lib.home}/aspectjrt.jar"/>
        <!-- Put two paths for tools.jar on the classpath, in case java.home is pointed at the JRE in the ./jre
             subdirectory of the JDK -->
        <pathelement path="${java.home}/lib/tools.jar"/>
        <pathelement path="${java.home}/../lib/tools.jar"/>
    </path>

    <path id="test.run.classpath">
        <path refid="test.build.classpath"/>
        <pathelement location="${test.build.home}/classes" />
    </path>

    <target name="build" depends="build-java-client,prepare,build-qc-validator" description="Compile Java sources">
        <loadfile property="moduleDirectories" srcfile="${modulesFile.fullpath}">
            <filterchain>
                <striplinecomments>
                    <comment value="#"/>
                </striplinecomments>
                <expandproperties/>
                <suffixlines suffix="/test,"/>
                <striplinebreaks/>
            </filterchain>
        </loadfile>
        <echo>${moduleDirectories}</echo>

        <loadfile property="moduleSources" srcfile="${modulesFile.fullpath}">
            <filterchain>
                <striplinecomments>
                    <comment value="#"/>
                </striplinecomments>
                <expandproperties/>
                <suffixlines suffix="/test/src/**/*,"/>
                <striplinebreaks/>
            </filterchain>
        </loadfile>

        <!-- This selector detects all modules with tests -->
        <selector id="test.module.selector">
             <present targetdir="${project.root}">
                  <mapper type="glob" from="*" to="*/src"/>
             </present>
        </selector>

        <!-- This selector detects all modules without a skipBuild.txt file in the module root -->
        <selector id="skip.module.selector">
            <not>
                <present targetdir="${project.root}">
                    <mapper type="glob" from="*" to="*/../skipBuild.txt"/>
                </present>
            </not>
        </selector>

        <!-- Create a path that includes all individual module test directories -->
        <path id="module.test.src.dirs">
            <dirset dir="${project.root}" includes="${moduleDirectories}">
                <selector refid="test.module.selector"/>
                <selector refid="skip.module.selector"/>
            </dirset>
        </path>

        <path id="full.test.build.classpath">
            <path refid="test.build.classpath"/>
            <path refid="module.test.src.dirs"/>
        </path>

        <antcall target="force_compile"/>

        <uptodate targetfile="${test.build.uptodate}" property="testClassesUpToDate">
            <srcfiles dir="${project.root}" includes="${moduleSources}">
                <include name="server/test/src/**/*"/>
                <include name="server/test/lib/**/*"/>
                <include name="server/${modulesFile}"/>
            </srcfiles>
        </uptodate>

        <antcall target="compileIfDirty" inheritrefs="true"/>

        <antcall target="write_sampledata_path" inheritrefs="true" />
    </target>

    <target name="force_compile">
        <loadfile property="previous.modulesFile" srcfile="${test.build.uptodate}" failonerror="false"/>
        <if>
            <not>
                <equals arg1="${previous.modulesFile}" arg2="${modulesFile}"/>
            </not>
            <then>
                <delete file="${test.build.uptodate}"/>
            </then>
        </if>
    </target>

    <target name="compileIfDirty" unless="testClassesUpToDate">
        <taskdef
            resource="org/aspectj/tools/ant/taskdefs/aspectjTaskdefs.properties">
          <classpath>
            <pathelement location="${test.lib.home}/aspectjtools.jar"/>
          </classpath>
        </taskdef>

        <antcall target="clean" />
        <antcall target="prepare" />

        <iajc
            destdir="${test.build.home}/classes"
            debug="${test.compile.debug}"
            deprecation="${test.compile.deprecation}"
            source="${java.source.and.target}"
            classpathref="full.test.build.classpath">
            <src path="${test.src.home}"/>
            <src refid="module.test.src.dirs"/>
        </iajc>
        <copy todir="${test.build.home}/classes" >
            <fileset dir="${test.src.home}">
                <include name="**/*.js"/>
            </fileset>
        </copy>
        <echo file="${test.build.uptodate}" message="${modulesFile}"/>
    </target>

    <target name="write_sampledata_path">
        <!-- This selector detects all modules with tests -->
        <selector id="sampledata.selector">
            <present targetdir="${project.root}">
                <mapper type="glob" from="*" to="*/sampledata"/>
            </present>
        </selector>

        <!-- Create a path that includes all sampledata directories -->
        <path id="sampledata.roots">
            <path location="${project.root}"/>
            <path>
                <dirset dir="${project.root}" includes="${moduleDirectories}">
                    <selector refid="sampledata.selector"/>
                    <selector refid="skip.module.selector"/>
                </dirset>
            </path>
        </path>

        <pathconvert property="sampledata.dirs" refid="sampledata.roots" pathsep=";">
            <globmapper from="*" to="*${file.separator}sampledata"/>
        </pathconvert>

        <echo message="${sampledata.dirs}" file="${test.build.home}/sampledata.dirs"/>
        <echo message=";${project.root}/server/test/data" file="${test.build.home}/sampledata.dirs" append="true"/>
    </target>

    <path id="ant.contrib.classpath">
        <pathelement path="${external.lib.home}/../build/ant-contrib/ant-contrib-1.0b3.jar" />
        <fileset dir="${external.lib.home}/../build/ant-contrib/lib">
            <include name="*.jar"/>
        </fileset>
    </path>
    <taskdef resource="net/sf/antcontrib/antlib.xml" classpathref="ant.contrib.classpath" />

    <target name="package-chrome-extensions">
        <delete>
            <fileset dir="${chrome.extensions.dir}" includes="*.zip"/>
        </delete>
        <foreach target="zip_extension" param="srcdir">
            <path><dirset dir="${chrome.extensions.dir}" includes="*"/></path>
        </foreach>
    </target>

    <target name="zip_extension">
        <zip destfile="${srcdir}.zip">
            <zipfileset dir="${srcdir}" includes="*"/>
        </zip>
    </target>

    <target name="build-java-client" description="calls the jar task in the remoteapi/java/build.xml">
        <ant antfile="${javaclient.build.xml}" target="jar" inheritall="false"/>
    </target>

    <target name="setPassword" depends="build,set-user-props">
        <java classname="org.labkey.test.util.PasswordUtil">
            <sysproperty key="labkey.server" value="${sysprop.labkey.server}"/>
            <sysproperty key="labkey.port" value="${sysprop.labkey.port}"/>
            <classpath refid="test.run.classpath"/>
            <arg id="action" value="set"/>
        </java>
    </target>

    <target name="setTeamcityAgentPassword" depends="build">
        <java classname="org.labkey.test.util.PasswordUtil">
            <sysproperty key="labkey.port" value="${labkey.port}"/>
            <classpath refid="test.run.classpath"/>
            <arg id="action" value="set"/>
            <arg id="username" value="cruisecontrol@labkey.com"/>
            <arg id="password" value="cruisecontrol1!"/>
        </java>
    </target>

    <target name="ensurePassword" depends="build">
        <java classname="org.labkey.test.util.PasswordUtil" failonerror="true">
            <sysproperty key="labkey.port" value="${sysprop.labkey.port}"/>
            <classpath refid="test.run.classpath"/>
            <arg id="action" value="ensure"/>
        </java>
    </target>

    <target name="deploy-test-modules">
        <property name="coreTestModules" value="server/test/modules/*"/>
        <loadfile property="testModuleSources" srcfile="${modulesFile.fullpath}">
            <filterchain>
                <striplinecomments>
                    <comment value="#"/>
                </striplinecomments>
                <suffixlines suffix="/test/modules/*,"/>
                <striplinebreaks/>
            </filterchain>
        </loadfile>

        <ant antfile="${project.root}/server/build.xml" target="build_modules" inheritall="false">
            <property name="moduleDirectories" value="${coreTestModules},${testModuleSources}"/>
            <property name="skipDeployApp" value="true" />
        </ant>
        <ant antfile="${project.root}/server/build.xml" target="deployApp" inheritall="false"/>
    </target>

    <target name="continue" description="Continue running a stopped or failed test suite">
        <property name="suite" value="CONTINUE"/>
        <antcall inheritall="true" target="sub-selenium">
            <param name="debug.suspend.selenium" value="n" />
        </antcall>
    </target>

    <target name="continue-debug" description="Continue running a stopped or failed test suite, suspend until debugger attaches">
        <property name="suite" value="CONTINUE"/>
        <antcall inheritall="true" target="sub-selenium">
            <param name="debug.suspend.selenium" value="y" />
        </antcall>
    </target>

    <target name="study" description="Run Study Tests Only">
        <property name="suite" value="Study"/>
        <property name="debug.suspend.selenium" value="n"/>
        <antcall target="sub-selenium"/>
    </target>

    <target name="ms2t" description="Run all MS2 module tests only">
        <property name="suite" value="MS2"/>
        <property name="debug.suspend.selenium" value="n"/>
        <antcall target="sub-selenium"/>
    </target>

    <target name="ms2t-debug">
        <property name="suite" value="MS2"/>
        <property name="debug.suspend.selenium" value="y"/>
        <antcall target="sub-selenium"/>
    </target>

    <target name="cluster" description="Run MS2 module cluster pipeline tests only">
        <property name="suite" value="Cluster"/>
        <property name="debug.suspend.selenium" value="n"/>
        <antcall target="sub-selenium"/>
    </target>

    <target name="cluster-debug" description="Run MS2 module cluster pipeline tests only">
        <property name="suite" value="Cluster"/>
        <property name="debug.suspend.selenium" value="y"/>
        <antcall target="sub-selenium"/>
    </target>

    <target name="sub-selenium" depends="build-java-client" >
        <antcall target="kill_chromedriver" />

        <trycatch>
            <try>
                <antcall inheritall="true" target="runsuite">
                    <param name="debug.suspend" value="${debug.suspend.selenium}" />
                </antcall>
            </try>
            <finally>
                <antcall target="kill_chromedriver" />
            </finally>
        </trycatch>
    </target>

    <target name="set-debug-props">
        <condition property="debug.suspend.selenium" value="${debug.suspend.selenium}" else="n">
            <isset property="debug.suspend.selenium"/>
        </condition>
    </target>

    <target name="runsuite-selenium-tomcat" depends="kill_chromedriver,build,deploy-test-modules,set-user-props,set-debug-props,ensurePassword">
        <fail unless="tomcat.home" />

        <!--Can't pass empty values to jvmarg on Linux; use a dummy value instead-->
        <condition property="trustStore" value="-Djavax.net.ssl.trustStore=${tomcat.home}/localhost.truststore" else="-Dnull=null">
            <available file="${tomcat.home}/localhost.truststore" />
        </condition>
        <condition property="trustStorePassword" value="-Djavax.net.ssl.trustStorePassword=changeit" else="-Dnull=null">
            <available file="${tomcat.home}/localhost.truststore" />
        </condition>

        <ant inheritall="true" dir="${project.root}/server" antfile="${project.root}/server/build.xml" target="start_tomcat_teamcity" />
        <antcall target="waitfor-labkey-started"/>

        <condition property="sysprop.suiteToUse" value="${sysprop.moduleSuite}" else="${sysprop.suite}">
            <isset property="sysprop.moduleSuite"/>
        </condition>

        <junit fork="true" forkmode="once" maxmemory="512m"
                errorproperty="suite.failed" failureproperty="suite.failed"
                haltonfailure="false" haltonerror="false" showoutput="true">
            <jvmarg value="-Xmx512m"/>
            <jvmarg value="-Xdebug" />
            <jvmarg value="-Xrunjdwp:transport=dt_socket,server=y,suspend=${debug.suspend.selenium},address=${sysprop.selenium.debug.port}" />
            <jvmarg value="${trustStore}" />
            <jvmarg value="${trustStorePassword}"/>
            <classpath refid="test.run.classpath"/>
            <sysproperty key="suite" value="${sysprop.suiteToUse}"/>
            <sysproperty key="cleanOnly" value="${sysprop.cleanOnly}"/>
            <sysproperty key="test" value="${sysprop.test}"/>
            <sysproperty key="clean" value="${sysprop.clean}"/>
            <sysproperty key="loop" value="${sysprop.loop}"/>
            <sysproperty key="linkCheck" value="${sysprop.linkCheck}"/>
            <sysproperty key="injectCheck" value="${sysprop.injectCheck}"/>
            <sysproperty key="memCheck" value="${sysprop.memCheck}"/>
            <sysproperty key="scriptCheck" value="${sysprop.scriptCheck}"/>
            <sysproperty key="queryCheck" value="${sysprop.queryCheck}"/>
            <sysproperty key="viewCheck" value="${sysprop.viewCheck}"/>
            <sysproperty key="failure.output.dir" value="${test.log.output.dir}"/>
            <sysproperty key="labkey.root" value="${project.root}"/>
            <sysproperty key="labkey.port" value="${sysprop.labkey.port}"/>
            <sysproperty key="labkey.server" value="${sysprop.labkey.server}"/>
            <sysproperty key="labkey.contextpath" value="${sysprop.labkey.contextpath}"/>
            <sysproperty key="selenium.browser" value="${sysprop.selenium.browser}"/>
            <sysproperty key="selenium.browser.path" value="${sysprop.selenium.browser.path}"/>
            <sysproperty key="testRecentlyFailed" value="${sysprop.testRecentlyFailed}" />
            <sysproperty key="teamcity.tests.recentlyFailedTests.file" value="${sysprop.teamcity.tests.recentlyFailedTests.file}" />
            <sysproperty key="testNewAndModified" value="${sysprop.testNewAndModified}" />
            <sysproperty key="teamcity.build.changedFiles.file" value="${sysprop.teamcity.build.changedFiles.file}" />
            <sysproperty key="shuffleTests" value="${sysprop.shuffleTests}" />
            <sysproperty key="disableAssertions" value="${sysprop.disableAssertions}"/>
            <sysproperty key="devMode" value="${sysprop.devMode}"/>
            <sysproperty key="maxTestFailures" value="${maxTestFailures}"/>
            <sysproperty key="databaseType" value="${sysprop.databaseType}"/>
            <sysproperty key="databaseVersion" value="${sysprop.databaseVersion}"/>
            <sysproperty key="webdriver.ie.driver" value="${webdriver.ie.driver}"/>
            <sysproperty key="webdriver.chrome.driver" value="${webdriver.chrome.driver}"/>
            <sysproperty key="selenium.reuseWebDriver" value="${selenium.reuseWebDriver}"/>
            <sysproperty key="dump.svgs" value="${dump.svgs}"/>
            <sysproperty key="user.home" value="${user.home}"/>
            <sysproperty key="teamcity.buildType.id" value="${teamcity.buildType.id}"/>
            <sysproperty key="additional.pipeline.tools" value="${additional.pipeline.tools}"/>
            <sysproperty key="test.credentials.file" value="${test.credentials.file}"/>

            <formatter type="brief"/>
            <formatter type="xml"/>

            <test name="org.labkey.test.Runner"
                todir="${test.log.output.dir}" outfile="${sysprop.suite}-results"/>
        </junit>
        <ant target="stop_tomcat" antfile="${project.root}/server/build.xml" inheritall="false"/>
        <antcall target="waitfor-tomcat-shutdown"/>
        <echo message="Copying log files from ${tomcat.home}/logs/ to ${test.log.output.dir}/${databaseType}/" />
        <mkdir dir="${test.log.output.dir}/${databaseType}" />
        <copy todir="${test.log.output.dir}/${databaseType}">
            <fileset dir="${tomcat.home}/logs/">
                <size value="0" units="k" when="more" />
            </fileset>
        </copy>

        <antcall target="kill_chromedriver" />

        <antcall target="fail_message"/>
    </target>

    <target name="waitfor-tomcat-shutdown">
      <property name="server.url" value="${sysprop.labkey.server}:${sysprop.labkey.port}"/>

      <echo message="waiting for the server to shutdown: ${server.url}"/>
      <waitfor maxwait="2" maxwaitunit="minute">
          <or>
            <not><socket server="${sysprop.labkey.server}" port="${sysprop.labkey.port}"/></not>
            <not><equals arg1="${sysprop.labkey.server}" arg2="localhost"/></not>
          </or>
      </waitfor>
    </target>

    <target name="ensure-tomcat-shutdown" if="tomcat.debug" depends="prepare">
        <path id="shutdown.build.classpath">
            <!-- Put two paths for tools.jar on the classpath, in case java.home is pointed at the JRE in the ./jre
                 subdirectory of the JDK -->
            <pathelement path="${java.home}/lib/tools.jar"/>
            <pathelement path="${java.home}/../lib/tools.jar"/>
        </path>
        <path id="shutdown.run.classpath">
            <path refid="shutdown.build.classpath" />
            <pathelement path="${test.build.home}/classes"/>
        </path>
        <javac srcdir="${test.src.home}/org/labkey/test/debug"
            destdir="${test.build.home}/classes"
            deprecation="${test.compile.deprecation}"
            debug="true"
            optimize="${test.compile.optimize}"
            source="${java.source.and.target}"
            classpathref="shutdown.build.classpath"
            includeantruntime="false" />
        <java classname="org.labkey.test.debug.ThreadDumpAndKill" failonerror="false">
            <classpath refid="shutdown.run.classpath"/>
            <arg value="${tomcat.debug}"/>
        </java>
    </target>

    <target name="fail_message" if="suite.failed">
        <echo message="${sysprop.suiteToUse} FAILED"/>
    </target>

    <target name="drt" description="run developer regression tests">
        <property name="debug.suspend.selenium" value="n"/>
        <property name="suite" value="DRT"/>
        <property name="selenium.browser" value="best"/>
        <antcall target="sub-selenium"/>
    </target>

    <target name="charting" description="run visualization related regression tests">
        <property name="debug.suspend.selenium" value="n"/>
        <property name="suite" value="Charting"/>
        <property name="selenium.browser" value="best"/>
        <antcall target="sub-selenium"/>
    </target>


    <target name="unit-tests" description="run junit tests">
        <property name="debug.suspend.selenium" value="n"/>
        <property name="suite" value="UnitTests"/>
        <antcall target="sub-selenium"/>
    </target>

    <target name="drt-debug" description="run drt, suspend until debugger attaches">
        <property name="debug.suspend.selenium" value="y"/>
        <property name="selenium.browser" value="best"/>
        <antcall target="sub-selenium"/>
    </target>

    <target name="kill_chromedriver" description="kill chromedriver processes">
        <exec osfamily="windows" executable="taskkill">
            <arg line="/F /IM chromedriver.exe"/>
        </exec>
        <exec osfamily="unix" executable="killall">
            <arg line="-HUP chromedriver"/>
        </exec>
    </target>

    <target name="module" description="Run Module test only">
        <property name="suite" value="Module"/>
        <property name="debug.suspend.selenium" value="n"/>
        <antcall target="sub-selenium">
        </antcall>
    </target>

    <target name="module-debug">
        <property name="suite" value="Module"/>
        <property name="debug.suspend.selenium" value="y"/>
        <antcall target="sub-selenium"/>
    </target>

    <target name="xtandem" description="Run X! Tandem tests only">
        <property name="suite" value="XTandem"/>
        <property name="debug.suspend.selenium" value="n"/>
        <antcall target="sub-selenium"/>
    </target>

    <target name="xtandem-debug">
        <property name="suite" value="XTandem"/>
        <property name="debug.suspend.selenium" value="y"/>
        <antcall target="sub-selenium"/>
    </target>

    <target name="mascot" description="Run Mascot tests only">
        <property name="suite" value="Mascot"/>
        <property name="debug.suspend.selenium" value="n"/>
        <antcall target="sub-selenium"/>
    </target>

    <target name="mascot-debug">
        <property name="suite" value="Mascot"/>
        <property name="debug.suspend.selenium" value="y"/>
        <antcall target="sub-selenium"/>
    </target>

    <target name="sequest" description="Run Sequest tests only">
        <property name="suite" value="Sequest"/>
        <property name="debug.suspend.selenium" value="n"/>
        <antcall target="sub-selenium"/>
    </target>

    <target name="flow" description="Run Flow tests only">
        <property name="suite" value="Flow"/>
        <property name="debug.suspend.selenium" value="n"/>
        <antcall target="sub-selenium"/>
    </target>

    <target name="sequest-debug">
        <property name="suite" value="Sequest"/>
        <property name="debug.suspend.selenium" value="y"/>
        <antcall target="sub-selenium"/>
    </target>

    <target name="drt-clean">
        <property name="suite" value="DRT"/>
        <property name="cleanOnly" value="true"/>
        <property name="selenium.browser" value="best"/>
        <antcall target="sub-selenium"/>
    </target>

    <target name="perf" description="run build verification tests">
        <property name="suite" value="Perf"/>
        <property name="debug.suspend.selenium" value="n"/>
        <property name="linkCheck" value="true"/>
        <antcall target="sub-selenium"/>
    </target>

    <target name="bvt" description="run build verification tests">
        <property name="suite" value="BVT"/>
        <property name="debug.suspend.selenium" value="n"/>
        <property name="linkCheck" value="true"/>
        <antcall target="sub-selenium"/>
    </target>

    <target name="bvt-debug" description="run bvt, suspend until debugger attaches">
        <property name="suite" value="BVT"/>
        <property name="debug.suspend.selenium" value="y"/>
        <property name="linkCheck" value="true"/>
        <antcall target="sub-selenium"/>
    </target>

    <target name="bvt-clean">
        <property name="suite" value="BVT"/>
        <property name="cleanOnly" value="true"/>
        <antcall target="sub-selenium"/>
    </target>

    <target name="daily" description="run daily verification tests">
        <property name="suite" value="Daily"/>
        <property name="debug.suspend.selenium" value="n"/>
        <property name="linkCheck" value="true"/>
        <antcall target="sub-selenium"/>
    </target>

    <target name="daily-debug" description="run daily verification tests">
        <property name="suite" value="Daily"/>
        <property name="debug.suspend.selenium" value="y"/>
        <property name="linkCheck" value="true"/>
        <antcall target="sub-selenium"/>
    </target>

    <target name="daily-clean" description="run daily verification tests">
        <property name="suite" value="Daily"/>
        <property name="cleanOnly" value="true"/>
        <antcall inheritall="true" target="sub-selenium"/>
    </target>

    <target name="test" description="runs UI for selecting and running specific tests">
        <property name="suite" value="TEST"/>
        <property name="debug.suspend.selenium" value="n"/>
        <antcall target="sub-selenium"/>
    </target>

    <target name="test-debug">
        <property name="suite" value="TEST"/>
        <property name="debug.suspend.selenium" value="y"/>
        <antcall target="sub-selenium"/>
    </target>

    <target name="init_database_properties">
        <!-- All we want are database names (loading jdbcURL and other properties now will cause problems) -->
        <loadproperties srcfile="${project.root}/server/config.properties">
            <filterchain>
                <linecontains>
                    <contains value="database"/>
                </linecontains>
            </filterchain>
        </loadproperties>
    </target>

    <target name="set-user-props" depends="init_database_properties">
        <!-- Set property sysprop.test: empty string if not provided, user string otherwise -->
        <condition property="sysprop.test" value="${test}" else="${default.test}">
            <isset property="test"/>
        </condition>

        <!-- Set property sysprop.cleanOnly: true or false -->
        <condition property="sysprop.cleanOnly" value="${cleanOnly}" else="${default.cleanOnly}">
            <isset property="cleanOnly"/>
        </condition>

        <!-- Set property sysprop.haltOnError: true or false -->
        <condition property="sysprop.haltOnError" value="${haltOnError}" else="${default.haltOnError}">
            <isset property="haltOnError"/>
        </condition>

        <!-- Set property sysprop.loop: true or false -->
        <condition property="sysprop.loop" value="${loop}" else="${default.loop}">
            <isset property="loop"/>
        </condition>

        <!-- Set property sysprop.noclean: true or false -->
        <condition property="sysprop.clean" value="${clean}" else="${default.clean}">
            <isset property="clean"/>
        </condition>

        <!-- Set property sysprop.linkCheck: true or false -->
        <condition property="sysprop.linkCheck" value="${linkCheck}" else="${default.linkCheck}">
            <isset property="linkCheck"/>
        </condition>

        <!-- Set property sysprop.injectCheck: true or false -->
        <condition property="sysprop.injectCheck" value="${injectCheck}" else="${default.injectCheck}">
            <isset property="injectCheck"/>
        </condition>

        <!-- Set property sysprop.memCheck: true or false -->
        <condition property="sysprop.memCheck" value="${memCheck}" else="${default.memCheck}">
            <isset property="memCheck"/>
        </condition>

        <!-- Set property sysprop.scriptCheck: true or false -->
        <condition property="sysprop.scriptCheck" value="${scriptCheck}" else="${default.scriptCheck}">
            <isset property="scriptCheck"/>
        </condition>

        <!-- Set property sysprop.queryCheck: true or false -->
        <condition property="sysprop.queryCheck" value="${queryCheck}" else="${default.queryCheck}">
            <isset property="queryCheck"/>
        </condition>

        <!-- Set property selenium.reuseWebDriver: true or false -->
        <condition property="selenium.reuseWebDriver" value="${selenium.reuseWebDriver}" else="${default.selenium.reuseWebDriver}">
            <isset property="selenium.reuseWebDriver"/>
        </condition>

        <!-- Set property sysprop.viewCheck: true or false -->
        <condition property="sysprop.viewCheck" value="${viewCheck}" else="${default.viewCheck}">
            <isset property="viewCheck"/>
        </condition>

        <!-- Set property sysprop.labkey.port: user provided or '8080' -->
        <condition property="sysprop.labkey.port" value="${labkey.port}" else="${default.labkey.port}">
            <isset property="labkey.port"/>
        </condition>

        <!-- Set property sysprop.labkey.server: user provided or 'http://localhost' -->
        <condition property="sysprop.labkey.server" value="${labkey.server}" else="${default.labkey.server}">
            <isset property="labkey.server"/>
        </condition>

        <!-- Set property sysprop.cpas.contextpath: user provided or '/labkey' -->
        <condition property="sysprop.labkey.contextpath" value="${labkey.contextpath}" else="${default.labkey.contextpath}">
            <isset property="labkey.contextpath"/>
        </condition>

        <!-- Set property sysprop.closeOnFail: true or false -->
        <condition property="sysprop.close.on.fail" value="${close.on.fail}" else="${default.close.on.fail}">
            <isset property="close.on.fail"/>
        </condition>

        <!-- Set property sysprop.selenium.browser -->
        <condition property="sysprop.selenium.browser" value="${selenium.browser}" else="${default.selenium.browser}">
            <isset property="selenium.browser"/>
        </condition>

        <!-- Set property sysprop.selenium.debug.port -->
        <condition property="sysprop.selenium.debug.port" value="${selenium.debug.port}" else="${default.selenium.debug.port}">
            <isset property="selenium.debug.port"/>
        </condition>

        <!-- Set property sysprop.selenium.browser.path -->
        <condition property="sysprop.selenium.browser.path" value="${selenium.browser.path}" else="${default.selenium.browser.path}">
            <isset property="selenium.browser.path"/>
        </condition>

        <!-- Set property sysprop.shuffleTests: true or false -->
        <condition property="sysprop.shuffleTests" value="${shuffleTests}" else="${default.shuffleTests}">
            <isset property="shuffleTests"/>
        </condition>

        <!-- Set property sysprop.disableAssertions: true or false -->
        <condition property="sysprop.disableAssertions" value="${disableAssertions}" else="${default.disableAssertions}">
            <isset property="disableAssertions"/>
        </condition>

        <!-- Set property sysprop.devMode: true or false -->
        <condition property="sysprop.devMode" value="${devMode}" else="${default.devMode}">
            <isset property="devMode"/>
        </condition>

        <!-- Set property sysprop.databaseType: "pg" or "mssql" -->
        <condition property="sysprop.databaseType" value="${databaseType}" else="${default.databaseType}">
            <isset property="databaseType"/>
        </condition>

        <!-- Set property sysprop.databaseVersion: db version string we use in TeamCity e.g. 9.1 or 2008 -->
        <condition property="sysprop.databaseVersion" value="${databaseVersion}" else="${default.databaseVersion}">
            <isset property="databaseVersion"/>
        </condition>

        <!-- Set property sysprop.suite: user provided string or DRT by default -->
        <condition property="sysprop.suite" value="${suite}" else="DRT">
            <isset property="suite"/>
        </condition>

        <condition property="additional.pipeline.tools" else="${default.additional.pipeline.tools}">
            <isset property="additional.pipeline.tools"/>
        </condition>

        <!-- Set property sysprop.teamcity.tests.recentlyFailedTests.file : Absolute path -->
        <condition property="sysprop.teamcity.tests.recentlyFailedTests.file" value="${teamcity.tests.recentlyFailedTests.file}" else="">
            <isset property="teamcity.tests.recentlyFailedTests.file"/>
        </condition>

        <!-- Set property sysprop.teamcity.build.changedFiles.file : Absolute path -->
        <condition property="sysprop.teamcity.build.changedFiles.file" value="${teamcity.build.changedFiles.file}" else="">
            <isset property="teamcity.build.changedFiles.file"/>
        </condition>

        <!-- Set property sysprop.teamcity.tests.runRiskGroupTestsFirst : recentlyFailed, newAndModified, or both/neither -->
        <condition property="sysprop.teamcity.tests.runRiskGroupTestsFirst"  value="${teamcity.tests.runRiskGroupTestsFirst}" else="">
            <isset property="teamcity.tests.runRiskGroupTestsFirst" />
        </condition>

        <!-- Set property testRecentlyFailed : true of false (set in TeamCity) -->
        <condition property="sysprop.testRecentlyFailed" value="true" else="false">
            <contains string="${sysprop.teamcity.tests.runRiskGroupTestsFirst}" substring="recentlyFailed" />
        </condition>

        <!-- Set property testNewModified : true of false (set in TeamCity) -->
        <condition property="sysprop.testNewAndModified" value="true" else="false">
            <contains string="${sysprop.teamcity.tests.runRiskGroupTestsFirst}" substring="newAndModified" />
        </condition>

        <condition property="webdriver.ie.driver" value="${test.dir}/bin/windows/amd64/IEDriverServer.exe">
            <and>
                <os family="windows"/>
                <os arch="amd64"/>
            </and>
        </condition>

        <condition property="webdriver.ie.driver" value="${test.dir}/bin/windows/i386/IEDriverServer.exe">
            <and>
                <os family="windows"/>
                <os arch="i386"/>
            </and>
        </condition>

        <condition property="webdriver.chrome.driver" value="${test.dir}/bin/windows/chromedriver.exe">
            <os family="windows"/>
        </condition>

        <condition property="webdriver.chrome.driver" value="${test.dir}/bin/mac/chromedriver">
            <os family="mac"/>
        </condition>

        <condition property="webdriver.chrome.driver" value="${test.dir}/bin/linux/amd64/chromedriver">
            <and>
                <os family="unix"/>
                <os arch="amd64"/>
                <not>
                    <os family="mac" />
                </not>
            </and>
        </condition>

        <condition property="webdriver.chrome.driver" value="${test.dir}/bin/linux/i386/chromedriver">
            <and>
                <os family="unix"/>
                <os arch="i386"/>
                <not>
                    <os family="mac" />
                </not>
            </and>
        </condition>


        <echo message="User property overrides:" />
        <echo message="    suite: ${sysprop.suite}"/>
        <echo message="    tests: ${sysprop.test}"/>
        <echo message="    clean up after test: ${sysprop.clean}"/>
        <echo message="    clean up only: ${sysprop.cleanOnly}"/>
        <echo message="    halt on error: ${sysprop.haltOnError}"/>
        <echo message="    loop forever: ${sysprop.loop}"/>
        <echo message="    link check: ${sysprop.linkCheck}"/>
        <echo message="    memory check: ${sysprop.memCheck}"/>
        <echo message="    script check: ${sysprop.scriptCheck}"/>
        <echo message="    query check: ${sysprop.queryCheck}"/>
        <echo message="    view check: ${sysprop.viewCheck}"/>
        <echo message="    labkey.port: ${sysprop.labkey.port}"/>
        <echo message="    target server ${sysprop.labkey.server}"/>
        <echo message="    labkey.contextpath: ${sysprop.labkey.contextpath}"/>
        <echo message="    database: ${sysprop.databaseType} ${sysprop.databaseVersion}" />
        <echo message="    shuffleTests: ${sysprop.shuffleTests}" />
        <echo message="    reuseWebDriver: ${selenium.reuseWebDriver}" />
        <echo message="    recently failed tests first (TeamCity only): ${sysprop.testRecentlyFailed}" />
        <echo message="    test modified modules first (TeamCity only): ${sysprop.testNewAndModified}" />
    </target>

    <target name="waitfor-labkey-started">
      <property name="server.started.url" value="${sysprop.labkey.server}:${sysprop.labkey.port}${sysprop.labkey.contextpath}/project/home/begin.view"/>

      <echo message="waiting for the server to start: ${server.started.url}"/>
      <waitfor maxwait="10" maxwaitunit="second" checkevery="100">
          <or>
            <http url="${server.started.url}" />
            <not><equals arg1="${sysprop.labkey.server}" arg2="localhost"/></not>
          </or>
      </waitfor>
    </target>

    <target name="runsuite" depends="build,package-chrome-extensions,deploy-test-modules,set-user-props,waitfor-labkey-started,install-rpackages,ensurePassword">
        <junit fork="true" forkmode="once" maxmemory="512m" showoutput="true"
                errorproperty="suite.failed" failureproperty="suite.failed"
                haltonfailure="${sysprop.haltOnError}"
                haltonerror="${sysprop.haltOnError}">
            <jvmarg value="-Xdebug" />
            <jvmarg value="-Xmx512m"/>
            <jvmarg value="-Xrunjdwp:transport=dt_socket,server=y,suspend=${debug.suspend},address=${sysprop.selenium.debug.port}" />
            <jvmarg value="-Djava.compiler=NONE" />
            <classpath refid="test.run.classpath" />
            <sysproperty key="suite" value="${sysprop.suite}"/>
            <sysproperty key="cleanOnly" value="${sysprop.cleanOnly}"/>
            <sysproperty key="test" value="${sysprop.test}"/>
            <sysproperty key="clean" value="${sysprop.clean}"/>
            <sysproperty key="loop" value="${sysprop.loop}"/>
            <sysproperty key="linkCheck" value="${sysprop.linkCheck}"/>
            <sysproperty key="injectCheck" value="${sysprop.injectCheck}"/>
            <sysproperty key="memCheck" value="${sysprop.memCheck}"/>
            <sysproperty key="scriptCheck" value="${sysprop.scriptCheck}"/>
            <sysproperty key="queryCheck" value="${sysprop.queryCheck}"/>
            <sysproperty key="viewCheck" value="${sysprop.viewCheck}"/>
            <sysproperty key="disableAssertions" value="${sysprop.disableAssertions}"/>
            <sysproperty key="devMode" value="${sysprop.devMode}"/>
            <sysproperty key="failure.output.dir" value="${test.log.output.dir}"/>
            <sysproperty key="labkey.root" value="${project.root}"/>
            <sysproperty key="labkey.port" value="${sysprop.labkey.port}"/>
            <sysproperty key="labkey.server" value="${sysprop.labkey.server}"/>
            <sysproperty key="labkey.contextpath" value="${sysprop.labkey.contextpath}"/>
            <sysproperty key="close.on.fail" value="${sysprop.close.on.fail}"/>
            <sysproperty key="selenium.browser" value="${sysprop.selenium.browser}"/>
            <sysproperty key="selenium.browser.path" value="${sysprop.selenium.browser.path}"/>
            <sysproperty key="testRecentlyFailed" value="${sysprop.testRecentlyFailed}" />
            <sysproperty key="teamcity.tests.recentlyFailedTests.file" value="${sysprop.teamcity.tests.recentlyFailedTests.file}" />
            <sysproperty key="testNewAndModified" value="${sysprop.testNewAndModified}" />
            <sysproperty key="teamcity.build.changedFiles.file" value="${sysprop.teamcity.build.changedFiles.file}" />
            <sysproperty key="shuffleTests" value="${sysprop.shuffleTests}" />
            <sysproperty key="maxTestFailures" value="${maxTestFailures}"/>
            <sysproperty key="databaseType" value="${sysprop.databaseType}"/>
            <sysproperty key="databaseVersion" value="${sysprop.databaseVersion}"/>
            <sysproperty key="webdriver.ie.driver" value="${webdriver.ie.driver}"/>
            <sysproperty key="webdriver.chrome.driver" value="${webdriver.chrome.driver}"/>
            <sysproperty key="selenium.reuseWebDriver" value="${selenium.reuseWebDriver}"/>
            <sysproperty key="dump.svgs" value="${dump.svgs}"/>
            <sysproperty key="user.home" value="${user.home}"/>
            <sysproperty key="teamcity.buildType.id" value="${teamcity.buildType.id}"/>
            <sysproperty key="additional.pipeline.tools" value="${additional.pipeline.tools}"/>
            <sysproperty key="test.credentials.file" value="${test.credentials.file}"/>

            <formatter type="brief"/>
            <formatter type="xml"/>

            <test name="org.labkey.test.Runner"
                todir="${test.log.output.dir}" outfile="${sysprop.suite}-results"/>
        </junit>
    </target>

    <!-- for testing the TestHelper ui -->
    <target name="testhelper-test" depends="build,set-user-props">
        <java classname="org.labkey.test.testpicker.TestHelper" fork="true">
            <classpath refid="test.run.classpath"/>
        </java>
    </target>

    <!-- Check if the QC validators JAR needs to be rebuilt, and if so rebuild it -->
    <target name="build-qc-validator">
        <condition property="qc.build.uptodate">
            <and>
                <uptodate targetfile="${project.root}/sampledata/qc/classes">
                    <srcfiles dir="${project.root}/sampledata/qc/src" />
                    <srcfiles dir="${project.root}/remoteapi/java/lib" />
                    <srcfiles dir="${project.root}/remoteapi/java/src" />
                </uptodate>
                <available file="${project.root}/sampledata/qc/transform.jar"/>
                <available file="${project.root}/sampledata/qc/validator.jar"/>
                <available file="${project.root}/sampledata/qc/validatorWarning.jar"/>
            </and>
        </condition>
        <antcall target="build-qc-validator-if-dirty" />
    </target>

    <target name="build-qc-validator-if-dirty" unless="qc.build.uptodate">
        <delete dir="${project.root}/sampledata/qc/classes"/>
        <delete file="${project.root}/sampledata/qc/validator.jar"/>
        <delete file="${project.root}/sampledata/qc/transform.jar"/>
        <delete file="${project.root}/sampledata/qc/transformWarning.jar"/>

        <mkdir dir="${project.root}/sampledata/qc/classes"/>
        <javac srcdir="${project.root}/sampledata/qc/src"
            destdir="${project.root}/sampledata/qc/classes"
            debug="${test.compile.debug}"
            deprecation="${test.compile.deprecation}"
            optimize="${test.compile.optimize}"
            source="${java.source.and.target}"
            classpathref="test.build.classpath"
            includeantruntime="false" >
        </javac>

        <mkdir dir="${project.root}/sampledata/qc"/>
        <jar destfile="${project.root}/sampledata/qc/validator.jar">
            <fileset dir="${project.root}/build/client-api/java/classes"/>
            <zipfileset src="${project.root}/remoteapi/java/lib/commons-codec-1.6.jar" includes="**/*.class"/>
            <zipfileset src="${project.root}/remoteapi/java/lib/httpcore-4.3.2.jar" includes="**/*.class"/>
            <zipfileset src="${project.root}/remoteapi/java/lib/httpclient-4.3.5.jar" includes="**/*.class"/>
            <zipfileset src="${project.root}/remoteapi/java/lib/commons-logging-1.1.3.jar" includes="**/*.class"/>
            <zipfileset src="${project.root}/remoteapi/java/lib/json_simple-1.1.jar" includes="**/*.class"/>
            <fileset dir="${project.root}/sampledata/qc/classes"/>
            <manifest>
                <attribute name="Built-By" value="${user.name}"/>
                <attribute name="Main-Class" value="org.labkey.AssayValidator"/>
            </manifest>
        </jar>
        <jar destfile="${project.root}/sampledata/qc/transform.jar">
            <fileset dir="${project.root}/build/client-api/java/classes"/>
            <zipfileset src="${project.root}/remoteapi/java/lib/commons-codec-1.6.jar" includes="**/*.class"/>
            <zipfileset src="${project.root}/remoteapi/java/lib/httpcore-4.3.2.jar" includes="**/*.class"/>
            <zipfileset src="${project.root}/remoteapi/java/lib/httpclient-4.3.5.jar" includes="**/*.class"/>
            <zipfileset src="${project.root}/remoteapi/java/lib/commons-logging-1.1.3.jar" includes="**/*.class"/>
            <zipfileset src="${project.root}/remoteapi/java/lib/json_simple-1.1.jar" includes="**/*.class"/>
            <fileset dir="${project.root}/sampledata/qc/classes"/>
            <manifest>
                <attribute name="Built-By" value="${user.name}"/>
                <attribute name="Main-Class" value="org.labkey.AssayTransform"/>
            </manifest>
        </jar>
        <jar destfile="${project.root}/sampledata/qc/transformWarning.jar">
            <fileset dir="${project.root}/build/client-api/java/classes"/>
            <zipfileset src="${project.root}/remoteapi/java/lib/commons-codec-1.6.jar" includes="**/*.class"/>
            <zipfileset src="${project.root}/remoteapi/java/lib/httpcore-4.3.2.jar" includes="**/*.class"/>
            <zipfileset src="${project.root}/remoteapi/java/lib/httpclient-4.3.5.jar" includes="**/*.class"/>
            <zipfileset src="${project.root}/remoteapi/java/lib/commons-logging-1.1.3.jar" includes="**/*.class"/>
            <zipfileset src="${project.root}/remoteapi/java/lib/json_simple-1.1.jar" includes="**/*.class"/>
            <fileset dir="${project.root}/sampledata/qc/classes"/>
            <manifest>
                <attribute name="Built-By" value="${user.name}"/>
                <attribute name="Main-Class" value="org.labkey.AssayTransformWarning"/>
            </manifest>
        </jar>
    </target>

    <target name="clean-rpackages">
        <ant antfile="${project.root}/tools/Rpackages/build.xml" target="clean-rpackages"/>
    </target>

    <target name="install-rpackages">
        <ant antfile="${project.root}/tools/Rpackages/build.xml" target="install-rpackages"/>
    </target>

    <target name="studysampler" depends="build">
        <copy file="${test.src.home}/org/labkey/test/studysampler/words.txt" todir="${test.build.home}/classes/"/>
        <java classname="org.labkey.test.studysampler.Runner">
            <classpath refid="test.run.classpath"/>
            <!-- set the input dir on the ant command line with -Dstudysampler.dir=/path/to/study/-->
            <arg value="${studysampler.dir}"/>
            <!-- set the subject list on the ant command line with -Dstudysampler.subjectfile=/path/to/file.txt-->
            <arg value="${studysampler.subjectfile}"/>
        </java>
    </target>

    <target name="skipfish_init">

        <condition property="skipfish.src.dir" value="${teamcity.agent.home.dir}/plugins/skipfish">
            <available file="${teamcity.agent.home.dir}/plugins/skipfish"/>
        </condition>

        <condition property="skipfish.built" value="true">
            <or>
                <available file="${skipfish.src.dir}/skipfish"/>
                <available file="${skipfish.src.dir}/skipfish.exe"/>
            </or>
        </condition>

        <condition property="skipfish.results.dir" value="${skipfish.results.dir}" else="${skipfish.src.dir}/results">
            <isset property="skipfish.results.dir"/>
        </condition>

        <condition property="skipfish.report.dir" value="${skipfish.report.dir}" else="${skipfish.src.dir}">
            <isset property="skipfish.report.dir"/>
        </condition>

        <condition property="skipfish.wordlist" value="${skipfish.wordlist}" else="new_dict.wl">
            <isset property="skipfish.wordlist"/>
        </condition>

        <condition property="skipfish.supplemental.wordlist" value="${skipfish.supplemental.wordlist}" else="minimal.wl">
            <isset property="skipfish.supplemental.wordlist"/>
        </condition>

        <condition property="sysprop.labkey.port" value="${labkey.port}" else="${default.labkey.port}">
            <isset property="labkey.port"/>
        </condition>

        <condition property="sysprop.labkey.server" value="${labkey.server}" else="${default.labkey.server}">
            <isset property="labkey.server"/>
        </condition>

        <condition property="sysprop.labkey.contextpath" value="${labkey.contextpath}" else="${default.labkey.contextpath}">
            <isset property="labkey.contextpath"/>
        </condition>

        <condition property="skipfish.timeout" value="${skipfish.timeout}" else="30">
            <isset property="skipfish.timeout"/>
        </condition>

        <condition property="cygwin.bin" value="${env.CYGWIN_HOME}\bin" else="C:\cygwin\bin">
            <isset property="env.CYGWIN_HOME"/>
        </condition>

        <property name="server.url" value="${sysprop.labkey.server}:${sysprop.labkey.port}${sysprop.labkey.contextpath}"/>

    </target>

    <target name="skipfish_scan" depends="skipfish_init, skipfish_make, skipfish_getCredentials">
        <delete dir="${skipfish.results.dir}"/>

        <touch file="${skipfish.src.dir}/${skipfish.wordlist}"/>
        <exec executable="${skipfish.src.dir}\skipfish.exe" dir="${skipfish.src.dir}" failifexecutionfails="false" osfamily="windows" errorproperty="skipfish.failed">
            <arg value="-u"/>
            <arg value="-o"/>
            <arg value="${skipfish.results.dir}"/>
            <arg value="-S"/>
            <arg value=".\dictionaries\${skipfish.supplemental.wordlist}"/>
            <arg value="-W"/>
            <arg value="${skipfish.wordlist}"/>
            <arg value="-X"/>
            <arg value="/logout.view"/>
            <arg value="-k"/>
            <arg value="${skipfish.timeout}"/>
            <arg value="-A"/>
            <arg value="${skipfish.credentials}"/>
            <arg value="${server.url}"/>
        </exec>
        <exec executable="${skipfish.src.dir}/skipfish" dir="${skipfish.src.dir}" failifexecutionfails="false" osfamily="unix" errorproperty="skipfish.failed">
            <arg value="-u"/>
            <arg value="-o"/>
            <arg value="${skipfish.results.dir}"/>
            <arg value="-S"/>
            <arg value="./dictionaries/${skipfish.supplemental.wordlist}"/>
            <arg value="-W"/>
            <arg value="${skipfish.wordlist}"/>
            <arg value="-X"/>
            <arg value="/logout.view"/>
            <arg value="-k"/>
            <arg value="${skipfish.timeout}"/>
            <arg value="-A"/>
            <arg value="${skipfish.credentials}"/>
            <arg value="${server.url}"/>
        </exec>
    </target>

    <target name="skipfish_make" unless="skipfish.built">
        <exec executable="${cygwin.bin}\make" dir="${skipfish.src.dir}" failifexecutionfails="false" osfamily="windows" errorproperty="skipfish.failed"/>
        <exec executable="make" dir="${skipfish.src.dir}" failifexecutionfails="false" osfamily="unix" errorproperty="skipfish.failed"/>
    </target>

    <target name="skipfish_clean">
        <exec executable="${cygwin.bin}\make" dir="${skipfish.src.dir}" failifexecutionfails="false" osfamily="windows" errorproperty="skipfish.failed">
            <arg value="clean"/>
        </exec>
        <exec executable="make" dir="${skipfish.src.dir}" failifexecutionfails="false" osfamily="unix" errorproperty="skipfish.failed">
            <arg value="clean"/>
        </exec>
    </target>

    <target name="skipfish_teamcity" description="Fire up tomcat and run skipfish" depends="skipfish_init">
        <ant target="start_tomcat_teamcity" inheritall="true" dir="${project.root}/server" antfile="${project.root}/server/build.xml"/>
        <antcall target="waitfor-labkey-started"/>
        <antcall target="skipfish_scan"/>
        <ant target="stop_tomcat" antfile="${project.root}/server/build.xml" inheritall="false"/>

        <delete file="${skipfish.report.dir}/skipfish.zip"/>
        <zip destfile="${skipfish.report.dir}/skipfish.zip" update="true" >
            <zipfileset dir="${skipfish.results.dir}"/>
        </zip>

        <antcall target="skipfish_fail"/>
    </target>

    <target name="skipfish_getCredentials" depends="build">
        <java classname="org.labkey.test.util.PasswordUtil" outputproperty="skipfish.credentials" failonerror="true">
            <classpath refid="test.run.classpath"/>
            <arg id="action" value="getSkipfishCredentials"/>
        </java>
    </target>

    <target name="skipfish_fail" if="skipfish.failed">
        <echo message="Skipfish FAILED"/>
    </target>

</project>
